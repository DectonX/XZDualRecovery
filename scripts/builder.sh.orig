#!/usr/bin/sudo /bin/bash
PRM=$(cd $(dirname "$0"); pwd)

MAJOR=`cat $PRM/version`
MINOR=`cat $PRM/minor`
REVISION=`cat $PRM/revision`

if [ "$1" = "beta" ]; then
	echo "BETA" > $PRM/release
	RELEASE=`cat $PRM/release`
	echo "Using the release label: ${RELEASE}."
elif [ "$1" = "release" ]; then
	echo "RELEASE" > $PRM/release
	RELEASE=`cat $PRM/release`
	echo "Using the release label: ${RELEASE}."
else
	RELEASE=`cat $PRM/release`
	echo "Using the release label: ${RELEASE}."
fi

if [ "$2" = "major" ]; then
	MAJOR=$((MAJOR + 1))
	MINOR=0
	REVISION=0
	echo "Building Locked Dual Recovery version ${MAJOR}.${MINOR}.${REVISION}..."
	echo ${MAJOR} > $PRM/version
	echo ${MINOR} > $PRM/minor
	echo ${REVISION} > $PRM/revision
elif [ "$2" = "new" ]; then
	MINOR=$((MINOR + 1))
	REVISION=0
	echo "Building Locked Dual Recovery version ${MAJOR}.${MINOR}.${REVISION}..."
	echo ${MINOR} > $PRM/minor
	echo ${REVISION} > $PRM/revision
else
	REVISION=$((REVISION + 1))
	echo "RE-Building Locked Dual Recovery version ${MAJOR}.${MINOR}.${REVISION}..."
	echo ${REVISION} > $PRM/revision
fi

# Remove previous .cpio's
echo "cleaning up..."
rm -f $PRM/files/*.zip
rm -f $PRM/files/*.tgz
rm -f $PRM/recovery.cwm.cpio.lzma
rm -f $PRM/recovery.twrp.cpio.lzma
rm -f $PRM/flashable/system/bin/recovery.cwm.cpio.lzma
rm -f $PRM/flashable/system/bin/recovery.twrp.cpio.lzma
rm -f $PRM/flashable/system/bin/chargemon
rm -f $PRM/flashable/system/bin/dualrecovery.sh
rm -f $PRM/flashable/system/xbin/busybox
rm -f $PRM/flashable/META-INF/com/google/android/updater-script
rm -f $PRM/flashable/backupchargemon.sh
rm -f $PRM/flashable/chargemon.c660x
rm -f $PRM/flashable/chargemon.c650x

rm -f $PRM/updater/system/bin/recovery.cwm.cpio.lzma
rm -f $PRM/updater/system/bin/recovery.twrp.cpio.lzma
rm -f $PRM/updater/system/bin/chargemon
rm -f $PRM/updater/system/bin/dualrecovery.sh
rm -f $PRM/updater/system/xbin/busybox
rm -f $PRM/updater/META-INF/com/google/android/updater-script
rm -f $PRM/updater/backupchargemon.sh
rm -f $PRM/updater/chargemon.c660x
rm -f $PRM/updater/chargemon.c650x

rm -f $PRM/installer/windows/lockeddualrecovery/files/recovery.cwm.cpio.lzma
rm -f $PRM/installer/windows/lockeddualrecovery/files/recovery.twrp.cpio.lzma
rm -f $PRM/installer/windows/lockeddualrecovery/files/chargemon.sh
rm -f $PRM/installer/windows/lockeddualrecovery/files/dualrecovery.sh
rm -f $PRM/installer/windows/lockeddualrecovery/files/superuser.sh
rm -f $PRM/installer/windows/lockeddualrecovery/files/supersu.sh
rm -f $PRM/installer/windows/lockeddualrecovery/files/busybox
rm -f $PRM/installer/windows/lockeddualrecovery/superuser.bat
rm -f $PRM/installer/windows/lockeddualrecovery/supersu.bat

rm -f $PRM/installer/linux/lockeddualrecovery/files/recovery.cwm.cpio.lzma
rm -f $PRM/installer/linux/lockeddualrecovery/files/recovery.twrp.cpio.lzma
rm -f $PRM/installer/linux/lockeddualrecovery/files/chargemon.sh
rm -f $PRM/installer/linux/lockeddualrecovery/files/dualrecovery.sh
rm -f $PRM/installer/linux/lockeddualrecovery/files/superuser.sh
rm -f $PRM/installer/linux/lockeddualrecovery/files/supersu.sh
rm -f $PRM/installer/linux/lockeddualrecovery/files/busybox
rm -f $PRM/installer/linux/lockeddualrecovery/superuser.sh
rm -f $PRM/installer/linux/lockeddualrecovery/supersu.sh

#rm -f $PRM/installer/mac/lockeddualrecovery/files/recovery.cwm.cpio.lzma
#rm -f $PRM/installer/mac/lockeddualrecovery/files/recovery.twrp.cpio.lzma
#rm -f $PRM/installer/mac/lockeddualrecovery/files/chargemon.sh
#rm -f $PRM/installer/mac/lockeddualrecovery/files/dualrecovery.sh
#rm -f $PRM/installer/mac/lockeddualrecovery/files/superuser.sh
#rm -f $PRM/installer/mac/lockeddualrecovery/files/supersu.sh
#rm -f $PRM/installer/mac/lockeddualrecovery/files/busybox
#rm -f $PRM/installer/mac/lockeddualrecovery/superuser.sh
#rm -f $PRM/installer/mac/lockeddualrecovery/supersu.sh

# make cpios
echo "creating new recovery archives..."
# TWRP
#rm -f $PRM/recovery.twrp.cpio.lzma
#rm -rf $PRM/ramdisk.twrp/*
#cp /storage/home/nut/development/xperia/cyanogen/twrp/android/system/out/target/product/yuga/ramdisk-recovery.cpio $PRM/ramdisk.twrp/
cd $PRM/ramdisk.twrp/
#cpio -i -u < ramdisk-recovery.cpio
#rm -f ramdisk-recovery.cpio
find . | cpio --create --format='newc' > $PRM/recovery.twrp.cpio
lzma -e -4 $PRM/recovery.twrp.cpio

# CWM
#rm -f $PRM/recovery.cwm.cpio.lzma
#rm -rf $PRM/ramdisk.cwm/*
#cp /storage/home/nut/development/xperia/cyanogen/cwm/android/system/out/target/product/yuga/ramdisk-recovery.cpio $PRM/ramdisk.cwm/
cd $PRM/ramdisk.cwm/
#cpio -i -u < ramdisk-recovery.cpio
#rm -f ramdisk-recovery.cpio
find . | cpio --create --format='newc' > $PRM/recovery.cwm.cpio
lzma -e -4 $PRM/recovery.cwm.cpio

cd $PRM/
echo "Flashable: copying files to their locations..."
# Flashable
cp $PRM/recovery.cwm.cpio.lzma $PRM/flashable/system/bin/recovery.cwm.cpio.lzma
cp $PRM/recovery.twrp.cpio.lzma $PRM/flashable/system/bin/recovery.twrp.cpio.lzma
cp $PRM/chargemon $PRM/flashable/system/bin/chargemon
cp $PRM/dualrecovery.sh $PRM/flashable/system/bin/dualrecovery.sh
cp $PRM/busybox $PRM/flashable/system/xbin/busybox
cp $PRM/backupchargemon.sh $PRM/flashable/backupchargemon.sh
cp $PRM/chargemon.c660x $PRM/flashable/chargemon.c660x
cp $PRM/chargemon.c650x $PRM/flashable/chargemon.c650x
cp $PRM/flashable_script $PRM/flashable/META-INF/com/google/android/updater-script

cd $PRM/flashable
echo "Creating flashable zip..."
zip -r -b /tmp ../files/lockeddualrecovery${MAJOR}.${MINOR}.${REVISION}-${RELEASE}.zip *

echo "Updater: copying files to their locations..."
# Updater
cp $PRM/recovery.cwm.cpio.lzma $PRM/updater/system/bin/recovery.cwm.cpio.lzma
cp $PRM/recovery.twrp.cpio.lzma $PRM/updater/system/bin/recovery.twrp.cpio.lzma
cp $PRM/chargemon $PRM/updater/system/bin/chargemon
cp $PRM/dualrecovery.sh $PRM/updater/system/bin/dualrecovery.sh
cp $PRM/busybox $PRM/updater/system/xbin/busybox
cp $PRM/backupchargemon.sh $PRM/updater/backupchargemon.sh
cp $PRM/chargemon.c660x $PRM/updater/chargemon.c660x
cp $PRM/chargemon.c650x $PRM/updater/chargemon.c650x
cp $PRM/updater_script $PRM/updater/META-INF/com/google/android/updater-script

cd $PRM/updater
echo "Creating updater zip..."
zip -r -b /tmp ../files/lockeddualrecovery-${RELEASE}.update.zip *

echo "Windows installer: copying files to their locations..."
# WINDOWS Installer
cp $PRM/recovery.cwm.cpio.lzma $PRM/installer/windows/lockeddualrecovery/files/recovery.cwm.cpio.lzma
cp $PRM/recovery.twrp.cpio.lzma $PRM/installer/windows/lockeddualrecovery/files/recovery.twrp.cpio.lzma
cp $PRM/busybox $PRM/installer/windows/lockeddualrecovery/files/busybox
cp $PRM/chargemon $PRM/installer/windows/lockeddualrecovery/files/chargemon.sh
cp $PRM/dualrecovery.sh $PRM/installer/windows/lockeddualrecovery/files/dualrecovery.sh
cp $PRM/superuser.sh $PRM/installer/windows/lockeddualrecovery/files/superuser.sh
cp $PRM/supersu.sh $PRM/installer/windows/lockeddualrecovery/files/supersu.sh
cp $PRM/superuser.bat $PRM/installer/windows/lockeddualrecovery/superuser.bat
cp $PRM/supersu.bat $PRM/installer/windows/lockeddualrecovery/supersu.bat

cd $PRM/installer/windows
echo "Creating windows installer zip..."
zip -r -b /tmp ../../files/lockeddualrecovery${MAJOR}.${MINOR}.${REVISION}-${RELEASE}.windows.zip *

echo "Linux installer: copying files to their locations..."
# LINUX Installer
cp $PRM/recovery.cwm.cpio.lzma $PRM/installer/linux/lockeddualrecovery/files/recovery.cwm.cpio.lzma
cp $PRM/recovery.twrp.cpio.lzma $PRM/installer/linux/lockeddualrecovery/files/recovery.twrp.cpio.lzma
cp $PRM/busybox $PRM/installer/linux/lockeddualrecovery/files/busybox
cp $PRM/chargemon $PRM/installer/linux/lockeddualrecovery/files/chargemon.sh
cp $PRM/dualrecovery.sh $PRM/installer/linux/lockeddualrecovery/files/dualrecovery.sh
cp $PRM/superuser.sh $PRM/installer/linux/lockeddualrecovery/files/superuser.sh
cp $PRM/supersu.sh $PRM/installer/linux/lockeddualrecovery/files/supersu.sh
cp $PRM/installersuperuser.sh $PRM/installer/linux/lockeddualrecovery/superuser.sh
cp $PRM/installersupersu.sh $PRM/installer/linux/lockeddualrecovery/supersu.sh

cd $PRM/installer/linux
echo "Creating linux installer tgz..."
tar zcvf ../../files/lockeddualrecovery${MAJOR}.${MINOR}.${REVISION}-${RELEASE}.linux.tgz *

#echo "MacOS installer: copying files to their locations..."
# MacOS Installer
#cp $PRM/recovery.cwm.cpio.lzma $PRM/installer/mac/lockeddualrecovery/files/recovery.cwm.cpio.lzma
#cp $PRM/recovery.twrp.cpio.lzma $PRM/installer/mac/lockeddualrecovery/files/recovery.twrp.cpio.lzma
#cp $PRM/busybox $PRM/installer/mac/lockeddualrecovery/files/busybox
#cp $PRM/chargemon $PRM/installer/mac/lockeddualrecovery/files/chargemon.sh
#cp $PRM/dualrecovery.sh $PRM/installer/mac/lockeddualrecovery/files/dualrecovery.sh
#cp $PRM/superuser.sh $PRM/installer/mac/lockeddualrecovery/files/superuser.sh
#cp $PRM/supersu.sh $PRM/installer/mac/lockeddualrecovery/files/supersu.sh
#cp $PRM/superuser.bat $PRM/installer/mac/lockeddualrecovery/superuser.bat
#cp $PRM/supersu.bat $PRM/installer/mac/lockeddualrecovery/supersu.bat

#cd $PRM/installer/mac
#echo "Creating mac installer tgz..."
#tar zcvf ../../files/lockeddualrecovery${MAJOR}.${MINOR}-${RELEASE}.mac.tgz *

cd $PRM/files/
./update.sh
